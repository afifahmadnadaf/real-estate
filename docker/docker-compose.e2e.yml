version: '3.8'

services:
  nginx-cdn:
    image: nginx:1.27-alpine
    container_name: re-nginx-cdn
    restart: unless-stopped
    depends_on:
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    volumes:
      - ./nginx-cdn/default.conf:/etc/nginx/conf.d/default.conf:ro

  minio-init:
    image: minio/mc:latest
    container_name: re-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-lc"]
    command:
      - >-
        mc alias set local http://minio:9000 ${S3_ACCESS_KEY:-minio_access_key_change_me} ${S3_SECRET_KEY:-minio_secret_key_change_me} &&
        mc mb --ignore-existing local/real-estate-media &&
        mc mb --ignore-existing local/real-estate-invoices &&
        mc anonymous set download local/real-estate-media &&
        mc anonymous set download local/real-estate-invoices &&
        echo "minio init done"
    restart: "no"

  migrate:
    build:
      context: ../
      dockerfile: docker/migrate.Dockerfile
    container_name: re-migrate
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://admin:postgres_secret_password_change_me@postgres:5432/real_estate?schema=public
    restart: "no"

  fake-payments:
    build:
      context: ../
      dockerfile: services/fake-payments/Dockerfile
    container_name: re-fake-payments
    restart: unless-stopped
    ports:
      - "3099:3099"
    environment:
      - PORT=3099
      - WEBHOOK_TARGET_URL=http://api-gateway:3000/v1/webhooks/razorpay
      - RAZORPAY_WEBHOOK_SECRET=${RAZORPAY_WEBHOOK_SECRET:-local_razorpay_webhook_secret}
    depends_on:
      api-gateway:
        condition: service_started

